<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pok√©dex Ultimate en espa√±ol con todas las generaciones.">
    <title>Pok√©dex Ultimate - Gu√≠a Completa</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/5/53/Pok%C3%A9_Ball_icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #DC143C;
            --primary-blue: #1E3A8A;
            --primary-blue-rgb: 30, 58, 138;
            --electric-yellow: #FFD700;
            --electric-yellow-rgb: 255, 215, 0; 
            --grass-green: #22C55E;
            --grass-green-dark: #16A34A;
            --water-blue: #3B82F6;
            --fire-orange: #F97316;
            --psychic-pink: #EC4899;
            --dark-purple: #7C3AED;
            --steel-gray: #64748B;
            --fairy-pink: #F472B6;
            --shadow-dark: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-strong: rgba(0, 0, 0, 0.3);
            --gradient-background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --missing-red-border: #EF4444;
            --missing-red-bg: linear-gradient(135deg, #FFF1F2 0%, #FFE4E6 100%);
            --captured-green-bg: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            --nav-button-height: 2.5rem; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 150%; scroll-behavior: smooth; }
        body { height: 100%; font-family: 'Nunito', sans-serif; background: var(--gradient-background); color: #1F2937; overflow-x: hidden; }
        body.modal-open { overflow: hidden; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(1.25rem); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInSimple { from { opacity: 0; } to { opacity: 1; } } 
        @keyframes bounce {0%,20%,53%,80%,100%{transform:translate3d(0,0,0)}40%,43%{transform:translate3d(0,-.625rem,0)}70%{transform:translate3d(0,-.3125rem,0)}}
        @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        @keyframes float {0%,100%{transform:translateY(0)}50%{transform:translateY(-.5rem)}}
        @keyframes glowPulse {0%,100%{box-shadow:0 0 .3125rem rgba(255,215,0,.5)}50%{box-shadow:0 0 1.25rem rgba(255,215,0,.8)}}

        header {
            background: linear-gradient(135deg, var(--primary-red) 0%, #B91C1C 50%, var(--primary-blue) 100%);
            color: white; position: fixed; width: 100%; top: 0; left: 0; z-index: 1000;
            box-shadow: 0 0.5rem 2rem var(--shadow-strong); backdrop-filter: blur(0.625rem);
        }
        .banner {
            display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem;
            background: rgba(255,255,255,0.1); backdrop-filter: blur(0.625rem);
            border-bottom: 0.125rem solid var(--electric-yellow); position: relative; 
        }
        .user-nick {
            font-family: 'Press Start 2P', cursive; font-size: 0.7em; color: var(--electric-yellow);
            text-shadow: 0.125rem 0.125rem 0.25rem var(--shadow-strong); padding: 0.5rem 0.75rem;
            background: rgba(0,0,0,0.3); border-radius: 0.5rem; border: 0.125rem solid var(--electric-yellow);
            animation: pulse 3s infinite;
        }
        .banner-center-content {
            display: flex; align-items: center; justify-content: center; position: absolute;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        .logo-pokemon { height: 3rem; filter: drop-shadow(0.1875rem 0.1875rem 0.375rem var(--shadow-strong)); transition: transform 0.3s ease; }
        .logo-pokemon:hover { transform: scale(1.1) rotate(5deg); }

        nav {
            display: flex; justify-content: center; background: rgba(0,0,0,0.2); flex-wrap: wrap;
            align-items: center; padding: 0.5rem 1rem; 
            border-top: 0.1875rem solid var(--electric-yellow);
            backdrop-filter: blur(0.625rem); position: relative; z-index: 990; 
        }
        .nav-button, .nav-button-wrapper, .filter-dropdown-btn {
            background: linear-gradient(135deg, #FFFFFF 0%, #F3F4F6 100%); color: #374151;
            border: 0.125rem solid #D1D5DB;
            border-radius: 0.75rem;
            padding: 0 1rem;
            height: var(--nav-button-height);
            line-height: calc(var(--nav-button-height) - 0.25rem);
            cursor: pointer; font-size: 0.85em;
            position: relative; z-index: 1;
            font-weight: 700; text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position: relative; margin: 0.375rem;
            box-shadow: 0 0.25rem 0.375rem var(--shadow-dark), inset 0 0.0625rem 0 rgba(255,255,255,0.6);
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden;
            white-space: nowrap; 
        }
        .nav-button .icon, .nav-button-wrapper .icon, .filter-dropdown-btn .icon {
            margin-right: 0.5rem; font-size: 1.1em; 
            line-height: 1; 
        }
         .nav-button:hover:not(.active):not(:disabled),
         .nav-button-wrapper:hover:not(.active), 
         .filter-dropdown-btn:hover:not(.active),
         .filter-option:hover:not(.active) {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-color: #9CA3AF;
            transform: translateY(-0.125rem) scale(1.02);
            box-shadow: 0 0.5rem 1rem var(--shadow-medium), inset 0 0.0625rem 0 rgba(255,255,255,0.8);
        }
        .nav-button.active, .filter-option.active  {
            background: linear-gradient(135deg, var(--electric-yellow) 0%, #FCD34D 100%); color: var(--primary-red);
            border-color: #F59E0B; transform: scale(1.05);
            box-shadow: 0 0.375rem 0.75rem rgba(var(--electric-yellow-rgb),0.4), inset 0 0.125rem 0.25rem rgba(255,255,255,0.3);
        }
        .filter-option.active:hover {
            background: linear-gradient(135deg, var(--electric-yellow) 0%, #FCD34D 100%) !important; 
            border-color: #F59E0B !important;
            transform: scale(1.05) translateY(-0.0625rem); 
        }
        .nav-button.data-menu-btn .arrow-indicator {
            font-size: 0.8em; transition: transform 0.3s ease; margin-left: 0.375rem;
        }
        .nav-button.data-menu-btn.open .arrow-indicator { transform: rotate(180deg); }
        .controls-container {
            display: flex;
            align-items: center; 
            margin: 0.375rem; 
            background: rgba(100, 116, 139, 0.15); 
            padding: 0.25rem; 
            border-radius: calc(var(--nav-button-height) / 2 + 0.25rem); 
            backdrop-filter: blur(0.3125rem);
            border: 1px solid rgba(255, 255, 255, 0.15);
            gap: 0.25rem; 
        }
        .nav-button-wrapper { 
            margin: 0; 
            height: calc(var(--nav-button-height) - 0.25rem); 
            line-height: calc(var(--nav-button-height) - 0.5rem);
        }
        .nav-button-wrapper.search-wrapper { 
            padding: 0 0.375rem 0 0.75rem; 
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); 
            border-color: #ced4da;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .nav-button-wrapper.search-wrapper:hover {
            border-color: #adb5bd;
            transform: none; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.07);
        }
        #searchInput {
            padding: 0.375rem 0.25rem; 
            border: none; 
            width: 8rem; 
            font-size: 0.9em; 
            font-weight: 600;
            background: transparent; 
            color: #374151; 
            outline: none;
            height: 100%;
        }
        .nav-button-wrapper.search-wrapper .icon { 
            color: #4B5563; font-size: 1em; margin-right: 0.375rem;
        }
        #capture-counter-nav.nav-button-wrapper { 
            background: linear-gradient(135deg, var(--grass-green) 0%, var(--grass-green-dark) 100%);
            color: white; font-weight: 800;
            text-shadow: 0.0625rem 0.0625rem 0.125rem rgba(0,0,0,0.2);
            border-color: var(--grass-green-dark);
            min-width: 6rem; 
            justify-content: center; padding: 0 0.75rem;
        }
        #capture-counter-nav.nav-button-wrapper:hover { transform: none; box-shadow: 0 0.25rem 0.375rem var(--shadow-dark), inset 0 0.0625rem 0 rgba(255,255,255,0.6); }
        .filter-dropdown-btn { 
             margin: 0; 
        }
        .filter-dropdown-container,
        .data-dropdown-container {
            position: relative;
            display: flex;
            margin: 0 0.375rem;
        }
        .data-dropdown-container #btnDataMenu {
            margin: 0;
        }
        .controls-container .filter-dropdown-container .filter-dropdown-btn {
            margin: 0; 
        }
        .filter-dropdown-content,
        .data-dropdown-container .data-dropdown-content {
            display: none; position: absolute;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #152a6c 100%);
            min-width: 15rem;
            box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.25);
            z-index: 1001;
            border-radius: 0.625rem;
            border: 0.125rem solid var(--electric-yellow);
            padding: 0.5rem 0;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            backdrop-filter: blur(0.25rem);
            animation: fadeInSimple 0.15s ease-out;
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .filter-dropdown-container:hover .filter-dropdown-content,
        .data-dropdown-container:hover .data-dropdown-content { 
            display: block; 
        }
        .data-dropdown-content.show { display: block !important; }
          .filter-option,
          .data-dropdown-item {
            display: flex; align-items: center; gap: 0.5rem; 
            padding: 0.75rem 1.25rem; 
            color: #f0f0f0; font-size: 0.9em; font-weight: 600;
            text-decoration: none; background: none; border: none;
            width: 100%; text-align: left; cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease, border-radius 0.2s ease;
        }
        .filter-option:not(.active):hover,
        .data-dropdown-item:not(.active):hover {
            background: linear-gradient(135deg, rgba(var(--electric-yellow-rgb),0.25) 0%, rgba(var(--electric-yellow-rgb),0.15) 100%);
            color: var(--electric-yellow);
            transform: scale(1.02);
            border-radius: 0.375rem;
        }
        .filter-option .icon,
        .data-dropdown-item .icon {
            margin-right: 0.375rem; font-size: 1.1em;
        }
        .filter-option.active {
            background: linear-gradient(135deg, var(--electric-yellow) 0%, #FCD34D 100%);
            color: var(--primary-red); font-weight: 800;
            border-radius: 0.375rem; 
            box-shadow: 0 0.25rem 0.5rem rgba(var(--electric-yellow-rgb),0.3), inset 0 0.0625rem 0.125rem rgba(255,255,255,0.2);
            transform: scale(1.02); 
        }
          .filter-option.active .icon {
              color: var(--primary-red);
          }
          .filter-group { padding: 0.25rem 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
          .filter-group-title { display:block; font-size:0.75rem; font-weight:800; color: var(--electric-yellow); padding:0.25rem 1.25rem; text-transform:uppercase; }
        
        main { padding: 1.5rem; min-height: 100vh; }
        #status-message { text-align:center;font-size:1.2em;font-weight:600;color:#fff;padding:1rem 0;min-height:1.5rem;transition:all .3s ease;text-shadow:.0625rem .0625rem .125rem var(--shadow-dark)}
        .pokedex-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(15rem,1fr));gap:1.5rem;padding-top:1rem;justify-items:center}
        .pokedex-grid.search-results { display:flex;flex-wrap:wrap;justify-content:center;gap:1.5rem}
        .pokemon-card { background:var(--missing-red-bg);border:.1875rem solid var(--missing-red-border);border-radius:1.25rem;padding:0;text-align:center;cursor:pointer;transition:all .4s cubic-bezier(.4,0,.2,1);box-shadow:0 .5rem 1.5625rem var(--shadow-dark);position:relative;overflow:hidden;display:flex;flex-direction:column;width:15rem;height:20rem;transform-style:preserve-3d;perspective:62.5rem}
        .pokemon-card:hover { transform:translateY(-.75rem) scale(1.03) rotateX(5deg);box-shadow:0 1.25rem 2.5rem var(--shadow-medium);border-color:var(--electric-yellow)}
        .pokemon-card.captured { background:var(--captured-green-bg);border-color:var(--grass-green);box-shadow:0 .5rem 1.5625rem rgba(34,197,94,.2)}
          .pokemon-card.captured::after {
              content:"‚úì";position:absolute;
              bottom:.75rem;
              right:.75rem;
              font-size:1.8em;color:var(--grass-green);font-weight:900;
              text-shadow:.0625rem .0625rem .125rem var(--shadow-dark);
              animation:bounce 1s ease;
              z-index: 5;
          }
          .pokemon-card.favorite { border-color: var(--electric-yellow); box-shadow:0 0 1rem rgba(255,215,0,.5); }
          .pokemon-card-image-container { flex:1 1 65%;display:flex;align-items:center;justify-content:center;padding:1.5rem;border-bottom:.125rem solid #f1f5f9;overflow:hidden;position:relative;background:radial-gradient(circle at center,rgba(255,255,255,.1) 0%,transparent 70%)}
        .pokemon-card img { max-width:8.75rem;max-height:8.75rem;width:auto;height:auto;object-fit:contain;border-radius:.75rem;transition:transform .3s ease;filter:drop-shadow(.125rem .125rem .25rem var(--shadow-dark));animation:float 3s ease-in-out infinite}
        .pokemon-card:hover img { transform:scale(1.1) rotate(5deg)}
        .pokemon-card-info { flex:1 1 35%;padding:1rem;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:.5rem}
        .pokemon-card h3 { margin:0;font-size:1.2em;font-weight:800;text-transform:capitalize;line-height:1.3;color:#1f2937;text-shadow:.0625rem .0625rem .125rem rgba(255,255,255,.8)}
        .pokedex-number { font-size:.9em;color:#6b7280;margin:0;font-weight:600;background:rgba(107,114,128,.1);padding:.25rem .5rem;border-radius:.5rem}
        .pokemon-types { margin:0;display:flex;flex-wrap:wrap;justify-content:center;gap:.375rem}
        .type-badge { display:inline-block;padding:.375rem .75rem;border-radius:.75rem;font-size:.8em;font-weight:700;color:#fff;text-transform:uppercase;box-shadow:0 .125rem .25rem var(--shadow-dark);text-shadow:.0625rem .0625rem .0625rem var(--shadow-dark);transition:transform .2s ease;border:.0625rem solid rgba(255,255,255,.3)}
        .type-badge:hover { transform:scale(1.05)}
        .type-normal { background:linear-gradient(135deg,#a8a878 0%,#9c9c6b 100%)} .type-fire { background:linear-gradient(135deg,#f08030 0%,#e8691b 100%)} .type-water { background:linear-gradient(135deg,#6890f0 0%,#4f7cdb 100%)} .type-grass { background:linear-gradient(135deg,#78c850 0%,#5ba935 100%)} .type-electric { background:linear-gradient(135deg,#f8d030 0%,#f0c108 100%);color:#2d3748} .type-ice { background:linear-gradient(135deg,#98d8d8 0%,#7cc7c7 100%);color:#2d3748} .type-fighting { background:linear-gradient(135deg,#c03028 0%,#a8241c 100%)} .type-poison { background:linear-gradient(135deg,#a040a0 0%,#8b2f8b 100%)} .type-ground { background:linear-gradient(135deg,#e0c068 0%,#d4b046 100%)} .type-flying { background:linear-gradient(135deg,#a890f0 0%,#9180e0 100%)} .type-psychic { background:linear-gradient(135deg,#f85888 0%,#f03a6b 100%)} .type-bug { background:linear-gradient(135deg,#a8b820 0%,#94a61c 100%)} .type-rock { background:linear-gradient(135deg,#b8a038 0%,#a6912b 100%)} .type-ghost { background:linear-gradient(135deg,#705898 0%,#5e4a7a 100%)} .type-dragon { background:linear-gradient(135deg,#7038f8 0%,#5a1fe8 100%)} .type-steel { background:linear-gradient(135deg,#b8b8d0 0%,#a3a3c2 100%)} .type-dark { background:linear-gradient(135deg,#705848 0%,#5e4a3a 100%)} .type-fairy { background:linear-gradient(135deg,#f0b6bc 0%,#e8a1a8 100%)}
        
          .pokemon-card .card-info-btn {
            position: absolute;
            top: 0.625rem;
            right: 0.625rem;
            z-index: 15; 
            background-color: rgba(var(--primary-blue-rgb), 0.7);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            width: 2rem; 
            height: 2rem;
            font-size: 1rem; 
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1; 
            padding: 0; 
            box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.3);
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
          }
          .pokemon-card .card-info-btn:hover,
          .pokemon-card .card-info-btn:focus {
            background-color: rgba(var(--electric-yellow-rgb), 0.9);
            color: var(--primary-red);
            transform: scale(1.15);
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.4);
              outline: none;
          }
          .pokemon-card .card-compare-btn {
              position: absolute;
              top: 3rem;
              right: 0.625rem;
              z-index: 15;
              background-color: rgba(var(--primary-blue-rgb),0.7);
              color: white;
              border: 1px solid rgba(255,255,255,0.5);
              border-radius: 50%;
              width: 2rem;
              height: 2rem;
              font-size: 1rem;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              line-height: 1;
              padding: 0;
              box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.3);
              transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
          }
          .pokemon-card .card-compare-btn:hover,
          .pokemon-card .card-compare-btn:focus {
              background-color: rgba(var(--electric-yellow-rgb),1);
              color: var(--primary-red);
              transform: scale(1.15);
              box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.4);
              outline: none;
          }
          .pokemon-card .card-favorite-btn {
              position: absolute;
              top: 0.625rem;
              left: 0.625rem;
              z-index: 15;
              background-color: rgba(var(--electric-yellow-rgb),0.9);
              color: var(--primary-red);
              border: 1px solid rgba(255,255,255,0.5);
              border-radius: 50%;
              width: 2rem;
              height: 2rem;
              font-size: 1rem;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              line-height: 1;
              padding: 0;
              box-shadow: 0 0.125rem 0.375rem rgba(0,0,0,0.3);
              transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
          }
          .pokemon-card .card-favorite-btn:hover,
          .pokemon-card .card-favorite-btn:focus {
              background-color: rgba(var(--electric-yellow-rgb),1);
              transform: scale(1.15);
              box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.4);
              outline: none;
          }
        
        .loading-spinner { display:inline-block;width:1rem;height:1rem;border:.125rem solid rgba(255,255,255,.3);border-radius:50%;border-top:.125rem solid #fff;animation:spin 1s linear infinite;margin-left:.5rem}
        .legendary-pokemon { box-shadow:0 0 1.25rem rgba(255,215,0,.5);animation:glowPulse 2s infinite}
        .legendary-pokemon::before { content:"‚≠ê";position:absolute;top:.625rem;left:.625rem;font-size:1.5em;color:var(--electric-yellow);text-shadow:0 0 .3125rem rgba(255,215,0,.8);z-index:10}
        .mythical-pokemon { box-shadow:0 0 1.25rem rgba(236,72,153,.5)}
        .mythical-pokemon::before { content:"‚ú®";position:absolute;top:.625rem;left:.625rem;font-size:1.5em;color:var(--psychic-pink);text-shadow:0 0 .3125rem rgba(236,72,153,.8);z-index:10}
        #scrollToTop { position:fixed;bottom:1.25rem;right:1.25rem;width:3.125rem;height:3.125rem;background:var(--primary-red);color:#fff;border:none;border-radius:50%;cursor:pointer;display:flex;justify-content:center;align-items:center;font-size:1.5rem;box-shadow:0 .25rem .625rem rgba(0,0,0,.3);z-index:999;opacity:0;transform:translateY(1.25rem);transition:all .3s ease}
        #scrollToTop.visible { opacity:1;transform:translateY(0)}
        #scrollToTop:hover { background:var(--primary-blue);transform:translateY(-.3125rem)}
        .evolution-requirements { background:rgba(255,255,255,.1);border-radius:.5rem;padding:.5rem;margin-top:.5rem;border-left:.1875rem solid var(--electric-yellow)}
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 1050; display: none; align-items: center; justify-content: center;
            animation: fadeInOverlay 0.3s ease-out;
        }
        .modal-overlay.visible { display: flex; }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }

        .modal-container {
            background: var(--gradient-background);
            color: #f7fafc;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 0.75rem 1.5rem rgba(0,0,0,0.4);
            width: 90%; max-width: 50rem; 
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid var(--electric-yellow);
            animation: slideInModal 0.4s ease-out forwards;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 1rem; margin-bottom: 1rem;
            border-bottom: 1px solid var(--electric-yellow);
        }
        .modal-header h2 { 
            font-family: 'Press Start 2P', cursive; 
            font-size: 1.3em; color: var(--electric-yellow); 
            text-transform: capitalize;
            text-shadow: 1px 1px 2px var(--primary-red);
        }
        .modal-close-btn {
            background: none; border: none; color: var(--electric-yellow);
            font-size: 2em; font-weight: bold; cursor: pointer;
            transition: transform 0.2s ease; padding: 0.25rem; line-height: 1;
        }
        .modal-close-btn:hover { transform: scale(1.2) rotate(90deg); color: var(--primary-red); }
        
        .modal-body { display: flex; flex-wrap: wrap; gap: 1.5rem; }
        .modal-left-column { 
            flex: 1 1 15rem; 
            text-align: center; 
            display: flex; 
            flex-direction: column;
        }
        .modal-right-column { flex: 2 1 25rem; }

        .modal-pokemon-sprite { 
            max-width: 12rem; height: auto; margin: 0 auto 0.75rem auto;
            filter: drop-shadow(0.25rem 0.25rem 0.5rem var(--shadow-medium));
            background: rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .modal-pokemon-types { 
            margin-bottom: 0.75rem; 
        }
        .modal-pokemon-types .type-badge { font-size: 0.9em; padding: 0.5em 1em; }

        .modal-section { margin-bottom: 1.25rem; }
        .modal-section h4 {
            color: var(--electric-yellow); font-size: 1.1em; margin-bottom: 0.5rem;
            border-bottom: 1px dashed rgba(var(--electric-yellow-rgb), 0.5); padding-bottom: 0.25rem;
        }
        .modal-section p, .modal-section ul { font-size: 0.9em; line-height: 1.6; margin-bottom: 0.5rem; }
        .modal-section strong { color: var(--electric-yellow); font-weight: 700; }
        .modal-section ul { list-style: none; padding-left: 0; }
        .modal-section ul li { margin-bottom: 0.25rem; }

        .modal-stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr)); gap: 0.5rem;
        }
        .modal-stat { background-color: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.375rem; }
        .modal-stat-name { font-weight: 600; display: inline-block; width: 60%; }
        .modal-stat-value { font-weight: 700; color: var(--electric-yellow); }

        .type-effectiveness-group { margin-bottom: 0.75rem; }
        .type-effectiveness-group h5 { font-size: 0.95em; color: #eee; margin-bottom: 0.3rem; }
        .type-effectiveness-group .type-badge { margin: 0.1rem 0.2rem; font-size: 0.75em; }

        .modal-left-column > .modal-section#modalEvolutionSection {
            margin-bottom: 0.75rem; 
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: 0.5rem;
        }
        .modal-left-column > .modal-section#modalEvolutionSection h4 {
            font-size: 1em; 
            margin-bottom: 0.3rem;
            padding-bottom: 0.2rem;
        }
        .modal-left-column > .modal-section#modalEvolutionSection .evolution-requirements {
            font-size: 0.85em;
            text-align: left;
            padding: 0.25rem;
            margin-top: 0.25rem;
            border-left-width: .125rem;
        }
        .modal-left-column #modalToggleCaptureBtn {
            width:100%;
            margin-top: 0; 
        }


        @media (max-width:768px){
            .banner{padding:.5rem 1rem;flex-direction:column;gap:.5rem;}
            .banner-center-content{position:static;transform:none}
            nav{padding:.5rem;flex-direction:column}
            .nav-button, .filter-dropdown-btn, .data-dropdown-container{width:90%;margin-left:auto;margin-right:auto}
            .nav-button{padding:.5rem .75rem;font-size:.8em;margin:.25rem auto;justify-content:center}
            .controls-container{flex-direction:column;gap:.5rem;margin:.5rem auto;width:90%}
            .nav-button-wrapper{width:100%;justify-content:center;margin-left:0;margin-right:0}
            #searchInput{width:100%;text-align:center}
            .filter-dropdown-container .filter-dropdown-btn, .data-dropdown-container #btnDataMenu {width:100%;justify-content:center;margin:0}
            .filter-dropdown-container .filter-dropdown-content, .data-dropdown-container .data-dropdown-content {min-width:unset;width:100%;left:0;transform:none;}
            .pokedex-grid{grid-template-columns:repeat(auto-fill,minmax(12.5rem,1fr));gap:1rem}
            .pokemon-card{width:12.5rem;height:17.5rem}
            .pokemon-card img{max-width:7.5rem;max-height:7.5rem}
            main{padding:1rem}
            .modal-container { width: 95%; padding: 1rem; }
            .modal-header h2 { font-size: 1.1em; }
            .modal-body { flex-direction: column; }
            .modal-left-column #modalToggleCaptureBtn {
                margin-top: 1rem; 
            }
        }
        
        footer { text-align:center;padding:1.5rem;background:linear-gradient(135deg,#1f2937 0%,#374151 100%);color:#9ca3af;font-size:.9em;font-weight:600;border-top:.1875rem solid var(--electric-yellow)}
        footer p { margin-top:.625rem}
        .fade-in { animation:fadeInUp .4s ease forwards}
        .pokemon-card { opacity: 1; } 


        .notification { position:fixed;top:1.25rem;right:1.25rem;background:var(--primary-blue);color:#fff;border-left:.25rem solid var(--electric-yellow);padding:.9375rem 1.25rem;border-radius:.5rem;box-shadow:0 .3125rem .9375rem rgba(0,0,0,.3);z-index:9999;opacity:0;transform:translateX(1.875rem);transition:all .3s ease;max-width:18.75rem}
        .notification.show { opacity:1;transform:translateX(0)}
        .notification-title { font-weight:800;margin-bottom:.3125rem;display:flex;align-items:center}
        .notification-title span { margin-right:.5rem}
        .notification-message { font-size:.9em}

        .comparison-container {
            width:95%;
            max-width:70rem;
            max-height:90vh;
            font-size:0.9em;
            color:#000;
        }
        .comparison-container .modal-header {
            justify-content:center;
            position:relative;
        }
        #comparisonCloseBtn {
            position:absolute;
            right:0;
            top:0;
        }
        .comparison-grid { display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; }
        .comparison-grid .comp-column {
            flex:1 1 20rem;
            background:rgba(0,0,0,0.2);
            padding:1rem;
            border-radius:0.5rem;
            position:relative;
            color:#000;
        }
        .comparison-grid .comp-column.winner { background:var(--captured-green-bg); border:0.125rem solid var(--grass-green); }
        .comparison-grid .comp-column.loser { background:var(--missing-red-bg); border:0.125rem solid var(--missing-red-border); }
        .winner-label { text-align:center; font-weight:800; margin-bottom:0.5rem; color:var(--grass-green-dark); }
        .comp-column.loser .winner-label { color:var(--missing-red-border); }
        .comparison-grid .comp-column h3 { font-family:'Press Start 2P',cursive; font-size:1em; color:var(--electric-yellow); text-align:center; margin-bottom:0.5rem; text-transform:capitalize; }
        .comparison-grid .comp-column img { display:block; margin:0 auto 0.5rem auto; max-width:6rem; }
        .comparison-grid .comp-column ul { list-style:none; padding-left:0; font-size:0.9em; }
        .stats-table { width:100%; border-collapse:collapse; margin-bottom:0.5rem; }
        .stats-table th, .stats-table td { border:1px solid rgba(0,0,0,0.2); padding:0.25rem 0.5rem; text-align:center; font-size:0.85em; }
    </style>
</head>
<body>
    <header>
        <div class="banner">
            <span class="user-nick">Hecho por S1C4R1O</span>
            <div class="banner-center-content">
                <img src="https://logodownload.org/wp-content/uploads/2017/08/pokemon-logo.png" alt="Pokemon Logo" class="logo-pokemon">
            </div>
            <!-- Controles eliminados -->
        </div>
        <nav>
            <button id="btnHome" class="nav-button active">
                <span class="icon">üè†</span>NACIONAL
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnKanto" class="nav-button">
                <span class="icon">üóæ</span>Rojo (Kanto)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnJohto" class="nav-button">
                <span class="icon">üåÑ</span>Oro (Johto)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnHoenn" class="nav-button">
                <span class="icon">üåä</span>Rub√≠ (Hoenn)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnSinnoh" class="nav-button">
                <span class="icon">üèîÔ∏è</span>Diamante (Sinnoh)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnUnova" class="nav-button">
                <span class="icon">üèôÔ∏è</span>Negro (Unova)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnKalos" class="nav-button">
                <span class="icon">üî∑</span>X (Kalos)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnAlola" class="nav-button">
                <span class="icon">üå¥</span>Sol (Alola)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnEspadaGalar" class="nav-button">
                <span class="icon">‚öîÔ∏è</span>Espada (Galar)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
             <button id="btnHisui" class="nav-button">
                <span class="icon">üìú</span>Arceus (Hisui)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <button id="btnPurpura" class="nav-button">
                <span class="icon">üîÆ</span>P√∫rpura (Paldea)
                <span class="loading-spinner" style="display: none;"></span>
            </button>
            <div class="controls-container">
                <div class="nav-button-wrapper search-wrapper">
                    <span class="icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Buscar Pok√©mon...">
                </div>
                <div id="capture-counter-nav" class="nav-button-wrapper">0 / 0</div>
                
                <div class="filter-dropdown-container"> 
                    <button class="filter-dropdown-btn nav-button">
                        <span class="icon">üîΩ</span> Filtros
                    </button>
                    <div class="filter-dropdown-content">
                        <div class="filter-group">
                            <span class="filter-group-title">B√∫squeda</span>
                            <button class="filter-option" data-filter="all">üìã Todos los Pok√©mon</button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-group-title">Captura</span>
                            <button class="filter-option" data-filter="captured">‚úÖ Capturados</button>
                            <button class="filter-option" data-filter="missing">‚ùå Por capturar</button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-group-title">Rareza</span>
                            <button class="filter-option" data-filter="legendary">‚≠ê Legendarios</button>
                            <button class="filter-option" data-filter="mythical">üí´ Singulares</button>
                            <button class="filter-option" data-filter="favorite">‚ù§Ô∏è Favoritos</button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-group-title">Generaciones</span>
                            <button class="filter-option" data-filter="gen1">1Ô∏è‚É£ Gen I</button>
                            <button class="filter-option" data-filter="gen2">2Ô∏è‚É£ Gen II</button>
                            <button class="filter-option" data-filter="gen3">3Ô∏è‚É£ Gen III</button>
                            <button class="filter-option" data-filter="gen4">4Ô∏è‚É£ Gen IV</button>
                            <button class="filter-option" data-filter="gen5">5Ô∏è‚É£ Gen V</button>
                            <button class="filter-option" data-filter="gen6">6Ô∏è‚É£ Gen VI</button>
                            <button class="filter-option" data-filter="gen7">7Ô∏è‚É£ Gen VII</button>
                            <button class="filter-option" data-filter="gen8">8Ô∏è‚É£ Gen VIII</button>
                            <button class="filter-option" data-filter="gen9">9Ô∏è‚É£ Gen IX</button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-group-title">Tipos</span>
                            <button class="filter-option" data-filter="fire">üî• Tipo Fuego</button>
                            <button class="filter-option" data-filter="water">üíß Tipo Agua</button>
                            <button class="filter-option" data-filter="grass">üåø Tipo Planta</button>
                            <button class="filter-option" data-filter="electric">‚ö° Tipo El√©ctrico</button>
                            <button class="filter-option" data-filter="psychic">üîÆ Tipo Ps√≠quico</button>
                            <button class="filter-option" data-filter="dragon">üêâ Tipo Drag√≥n</button>
                            <button class="filter-option" data-filter="fairy">üßö Tipo Hada</button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-group-title">Stats</span>
                            <button class="filter-option" data-filter="attack100">üó°Ô∏è ATK ‚â•100</button>
                            <button class="filter-option" data-filter="defense100">üõ°Ô∏è DEF ‚â•100</button>
                            <button class="filter-option" data-filter="speed100">üí® VEL ‚â•100</button>
                        </div>
                    </div>
                </div>
                <div class="data-dropdown-container" id="dataMenuContainer">
                    <button id="btnDataMenu" class="nav-button data-menu-btn"> 
                        <span class="icon">üë§</span> Datos <span class="arrow-indicator">‚ñº</span>
                    </button>
                    <div class="data-dropdown-content" id="dataDropdownContent">
                        <button id="btnExportData" class="data-dropdown-item">
                           <span class="icon">üíæ</span> Exportar Capturas
                       </button>
                       <button id="btnImportDataTrigger" class="data-dropdown-item">
                           <span class="icon">üìÇ</span> Importar Capturas
                       </button>
                       <input type="file" id="fileImporter" accept=".json" style="display:none;">
                   </div>
               </div>
            </div>
        </nav>
    </header>
    
    <main>
        <div id="status-message" class="fade-in">üéØ Selecciona una Pok√©dex para comenzar tu aventura</div>
        <div id="pokedex-container" class="pokedex-grid"></div>
    </main>

    <div class="modal-overlay" id="pokemonModalOverlay">
        <div class="modal-container" id="pokemonModalContainer">
            <div class="modal-header">
                <h2 id="modalPokemonName"></h2>
                <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-left-column">
                    <img id="modalPokemonSprite" src="" alt="Pokemon Sprite" class="modal-pokemon-sprite">
                    <div id="modalPokemonTypes" class="modal-pokemon-types"></div>
                    <div class="modal-section" id="modalEvolutionSection">
                        <h4>üîÑ Evoluci√≥n</h4>
                        <div id="modalPokemonEvolution"></div>
                    </div>
                    <button id="modalToggleCaptureBtn" class="nav-button">Capturar</button>
                </div>
                <div class="modal-right-column">
                    <div class="modal-section">
                        <h4>üìñ Descripci√≥n</h4>
                        <p id="modalPokemonDescription"></p>
                    </div>
                    <div class="modal-section">
                        <h4>üìä Estad√≠sticas Base</h4>
                        <div id="modalPokemonStats" class="modal-stats-grid"></div>
                    </div>
                    <div class="modal-section">
                        <h4>‚ú® Habilidades</h4>
                        <ul id="modalPokemonAbilities"></ul>
                    </div>
                     <div class="modal-section" id="modalTypeEffectivenessSection">
                        <h4 id="modalTypeEffectivenessTitle">‚öîÔ∏è Efectividad Ofensiva</h4>
                        <div id="modalPokemonTypeEffectiveness"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="comparisonOverlay">
        <div class="modal-container comparison-container">
            <div class="modal-header">
                <h2>Comparativa</h2>
                <button id="comparisonCloseBtn" class="modal-close-btn" type="button">&times;</button>
            </div>
            <div id="comparisonContent" class="comparison-grid"></div>
        </div>
    </div>

    <button id="scrollToTop">‚Üë</button>

    <div id="notification" class="notification">
        <div class="notification-title"><span>üéâ</span> ¬°Notificaci√≥n!</div>
        <div class="notification-message">Mensaje de la notificaci√≥n.</div>
    </div>

    <footer>
        <p>üéÆ Pok√©dex Ultimate - Tu gu√≠a completa para ser el mejor entrenador Pok√©mon üéÆ</p>
        <p>üí´ Desarrollado con amor por la comunidad Pok√©mon üí´</p>
        <p style="margin-top: 0.625rem; font-size: 0.8em;">Actualizado: Octubre 2023 - Incluye todos los Pok√©mon hasta la novena generaci√≥n</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const headerElement = document.querySelector('header');
            const mainElement = document.querySelector('main');
            const pokedexContainer = document.getElementById('pokedex-container');
            const statusMessage = document.getElementById('status-message');
            const searchInput = document.getElementById('searchInput');
            const captureCounterNavElement = document.getElementById('capture-counter-nav');
            
            const scrollToTopBtn = document.getElementById('scrollToTop');
            const notification = document.getElementById('notification');

            const pokemonModalOverlay = document.getElementById('pokemonModalOverlay');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalPokemonName = document.getElementById('modalPokemonName');
            const modalPokemonSprite = document.getElementById('modalPokemonSprite');
            const modalPokemonTypes = document.getElementById('modalPokemonTypes');
            const modalPokemonDescription = document.getElementById('modalPokemonDescription');
            const modalPokemonStats = document.getElementById('modalPokemonStats');
            const modalPokemonAbilities = document.getElementById('modalPokemonAbilities');
            const modalPokemonEvolution = document.getElementById('modalPokemonEvolution');
            const modalEvolutionSection = document.getElementById('modalEvolutionSection'); 
            const modalToggleCaptureBtn = document.getElementById('modalToggleCaptureBtn');
            const modalTypeEffectivenessTitle = document.getElementById('modalTypeEffectivenessTitle');
            const modalPokemonTypeEffectiveness = document.getElementById('modalPokemonTypeEffectiveness');
            const comparisonOverlay = document.getElementById('comparisonOverlay');
            const comparisonContent = document.getElementById('comparisonContent');
            const comparisonCloseBtn = document.getElementById('comparisonCloseBtn');

            const btnHome = document.getElementById('btnHome');
            const btnEspadaGalar = document.getElementById('btnEspadaGalar');
            const btnHisui = document.getElementById('btnHisui');
            const btnPurpura = document.getElementById('btnPurpura');
            const allNavButtons = document.querySelectorAll('.nav-button:not(.dropdown-item):not(.data-menu-btn)');
            const btnKanto = document.getElementById("btnKanto");
            const btnJohto = document.getElementById("btnJohto");
            const btnHoenn = document.getElementById("btnHoenn");
            const btnSinnoh = document.getElementById("btnSinnoh");
            const btnUnova = document.getElementById("btnUnova");
            const btnKalos = document.getElementById("btnKalos");
            const btnAlola = document.getElementById("btnAlola");
            const filterOptions = document.querySelectorAll('.filter-option');
            
            const dataMenuContainer = document.getElementById('dataMenuContainer');
            const btnDataMenu = document.getElementById('btnDataMenu');
            const dataDropdownContent = document.getElementById('dataDropdownContent');
            const btnExportData = document.getElementById('btnExportData');
            // Bot√≥n Guardar y selector de idioma eliminados
            const btnImportDataTrigger = document.getElementById('btnImportDataTrigger');
            const fileImporter = document.getElementById('fileImporter');
            
            const API_BASE_URL = 'https://pokeapi.co/api/v2/';
            const MAX_NATIONAL_DEX_FETCH_LIMIT = 1025; 
            const REGIONAL_DEX_IDS = { kanto:2, johto:7, hoenn:4, sinnoh:5, unova:8, kalos:12, alola:16, espada_galar:27, hisui:30, purpura:31 };

            let capturedPokemon = new Set();
            let favoritePokemon = new Set();
            let currentPokedexFullData = [];
            let currentPokedexView = 'national';
            let activeFilters = new Set(['all']);
            let fetchAbortController = null;
            let currentPokemonInModal = null;
            let pinnedPokemon1 = null;
            let pinnedPokemon2 = null;

            const pokemonDetailsCache = new Map();
            const pokedexListCache = new Map();
            const typeTranslationsCache = new Map();
            const itemTranslationsCache = new Map();
            const evolutionCache = new Map();

            const typeNameMappingES = {"normal":"Normal","fire":"Fuego","water":"Agua","grass":"Planta","electric":"El√©ctrico","ice":"Hielo","fighting":"Lucha","poison":"Veneno","ground":"Tierra","flying":"Volador","psychic":"Ps√≠quico","bug":"Bicho","rock":"Roca","ghost":"Fantasma","dragon":"Drag√≥n","steel":"Acero","dark":"Siniestro","fairy":"Hada","unknown":"Desconocido"};
            const allSpanishTypeNames = Object.values(typeNameMappingES).map(n => n.toLowerCase());
            const romanToNumber = { i:1, ii:2, iii:3, iv:4, v:5, vi:6, vii:7, viii:8, ix:9 };
            const triggerNameMappingES = {"level-up":"Subir de nivel","trade":"Intercambio","use-item":"Usar objeto","shed":"Muda","three-critical-hits":"3 golpes cr√≠ticos","take-damage":"Recibir da√±o","spin":"Girar","tower-of-darkness":"Torre de la Oscuridad","tower-of-waters":"Torre de las Aguas","other":"Otro m√©todo","agile-style":"Estilo √Ågil","strong-style":"Estilo Fuerte"};
            const pokemonNameMappingES = { "bulbasaur":"Bulbasaur", "ivysaur":"Ivysaur", "venusaur":"Venusaur", "charmander":"Charmander", "charmeleon":"Charmeleon", "charizard":"Charizard", "squirtle":"Squirtle", "wartortle":"Wartortle", "blastoise":"Blastoise", "mewtwo":"Mewtwo", "mew":"Mew","meltan":"Meltan","melmetal":"Melmetal","grookey":"Grookey","thwackey":"Thwackey","rillaboom":"Rillaboom","scorbunny":"Scorbunny","raboot":"Raboot","cinderace":"Cinderace","sobble":"Sobble","drizzile":"Drizzile","inteleon":"Inteleon","sprigatito":"Sprigatito","floragato":"Floragato","meowscarada":"Meowscarada","fuecoco":"Fuecoco","crocalor":"Crocalor","skeledirge":"Skeledirge","quaxly":"Quaxly","quaxwell":"Quaxwell","quaquaval":"Quaquaval", "wyrdeer": "Wyrdeer", "kleavor": "Kleavor", "ursaluna": "Ursaluna", "basculegion-male": "Basculegion (Macho)", "sneasler": "Sneasler", "overqwil": "Overqwil", "enamorus-incarnate": "Enamorus (Forma Avatar)"};
            const itemNameMappingES = { "fire-stone":"Piedra Fuego","water-stone":"Piedra Agua", "peat-block":"Bloque de Turba", "black-augurite": "Mineral Negro", "linking-cord": "Cord√≥n Uni√≥n" };

            const typeChart = { 
                normal:   { rock: 0.5, ghost: 0, steel: 0.5 },
                fire:     { fire: 0.5, water: 0.5, grass: 2, ice: 2, bug: 2, rock: 0.5, dragon: 0.5, steel: 0.5 },
                water:    { fire: 2, water: 0.5, grass: 0.5, ground: 2, rock: 2, dragon: 0.5 },
                electric: { water: 2, electric: 0.5, grass: 0.5, ground: 0, flying: 2, dragon: 0.5 },
                grass:    { fire: 0.5, water: 2, grass: 0.5, poison: 0.5, ground: 2, flying: 0.5, bug: 0.5, rock: 2, dragon: 0.5, steel: 0.5 },
                ice:      { fire: 0.5, water: 0.5, grass: 2, ice: 0.5, ground: 2, flying: 2, dragon: 2, steel: 0.5 },
                fighting: { normal: 2, ice: 2, poison: 0.5, flying: 0.5, psychic: 0.5, bug: 0.5, rock: 2, ghost: 0, dark: 2, steel: 2, fairy: 0.5 },
                poison:   { grass: 2, poison: 0.5, ground: 0.5, rock: 0.5, ghost: 0.5, steel: 0, fairy: 2 },
                ground:   { fire: 2, electric: 2, grass: 0.5, poison: 2, flying: 0, bug: 0.5, rock: 2, steel: 2 },
                flying:   { grass: 2, fighting: 2, bug: 2, rock: 0.5, steel: 0.5, electric: 0.5 },
                psychic:  { fighting: 2, poison: 2, psychic: 0.5, dark: 0, steel: 0.5 },
                bug:      { fire: 0.5, grass: 2, fighting: 0.5, poison: 0.5, flying: 0.5, psychic: 2, ghost: 0.5, dark: 2, steel: 0.5, fairy: 0.5 },
                rock:     { fire: 2, ice: 2, flying: 2, bug: 2, fighting: 0.5, ground: 0.5, steel: 0.5 },
                ghost:    { psychic: 2, ghost: 2, dark: 0.5, normal: 0 },
                dragon:   { dragon: 2, steel: 0.5, fairy: 0 },
                steel:    { ice: 2, rock: 2, fairy: 2, steel: 0.5, fire: 0.5, water: 0.5, electric: 0.5 },
                dark:     { psychic: 2, ghost: 2, fighting: 0.5, dark: 0.5, fairy: 0.5 },
                fairy:    { fighting: 2, dragon: 2, dark: 2, fire: 0.5, poison: 0.5, steel: 0.5 }
            };
            const allTypeKeys = Object.keys(typeNameMappingES).filter(t => t !== "unknown");

            function adjustMainPadding() { if(headerElement&&mainElement){const headerHeightPx=headerElement.offsetHeight;const additionalPaddingPx=parseFloat(getComputedStyle(document.documentElement).fontSize)*1.25;mainElement.style.paddingTop=`${headerHeightPx+additionalPaddingPx}px`}}
            function showStatusMessage(message,isError=false){if(!statusMessage)return;statusMessage.innerHTML=message;statusMessage.style.color=isError?'#EF4444':'#FFFFFF';statusMessage.classList.add('fade-in')}
            function hideStatusMessage(){if(!statusMessage)return;setTimeout(()=>{statusMessage.style.opacity='0';setTimeout(()=>{statusMessage.textContent='';statusMessage.style.opacity='1'},300)},1E3)}
            function setLoadingState(button,isLoading){document.querySelectorAll('.nav-button, .filter-option').forEach(btn=>btn.disabled=isLoading);if(searchInput)searchInput.disabled=isLoading;const spinner=button?.querySelector('.loading-spinner');if(spinner)spinner.style.display=isLoading?'inline-block':'none'}
            function showNotification(title,message,emoji="üéâ",delay=3E3){if(!notification)return;notification.querySelector('.notification-title').innerHTML=`<span>${emoji}</span> ${title}`;notification.querySelector('.notification-message').textContent=message;notification.classList.add('show');setTimeout(()=>{notification.classList.remove('show')},delay)}
            async function fetchJson(url,signal){try{const response=await fetch(url,{signal});if(!response.ok){if(response.status===404){console.warn(`Recurso no encontrado: ${url}`);return null}throw new Error(`Error API ${response.status}: ${response.statusText}`)}return await response.json()}catch(error){if(error.name==='AbortError')return null;console.error(`Error al obtener ${url}:`,error);throw error}}
            async function getTranslatedName(apiType,nameEn,cache,manualMapping,signal){const key=`${apiType}-${nameEn}`;if(cache.has(key))return cache.get(key);if(manualMapping&&manualMapping[nameEn]){cache.set(key,manualMapping[nameEn]);return manualMapping[nameEn]}if(apiType==='pokemon-species'){const fallbackName=nameEn.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());cache.set(key,fallbackName);return fallbackName}const apiName=nameEn.replace(/\s+/g,'-').toLowerCase();const data=await fetchJson(`${API_BASE_URL}${apiType}/${apiName}`,signal);if(data&&data.names){const nameEsEntry=data.names.find(n=>n.language.name==='es');if(nameEsEntry){cache.set(key,nameEsEntry.name);return nameEsEntry.name}}const fallbackName=nameEn.replace(/-/g,' ');cache.set(key,fallbackName);return fallbackName}
            async function getPokemonDetails(idOrName,signal){const cacheKey=String(idOrName).toLowerCase();if(pokemonDetailsCache.has(cacheKey))return pokemonDetailsCache.get(cacheKey);const data=await fetchJson(`${API_BASE_URL}pokemon/${idOrName}`,signal);if(!data||signal.aborted)return null;let speciesData=null;try{speciesData=await fetchJson(data.species.url,signal);if(signal.aborted)return null}catch(error){console.warn(`No se pudo obtener datos de la especie para ${data.name} (${data.id})`)}const nationalId=speciesData?speciesData.id:data.id;const typesInEnglish=data.types.map(typeInfo=>typeInfo.type.name);const typesInSpanish=(await Promise.all(typesInEnglish.map(typeEn=>getTranslatedName('type',typeEn,typeTranslationsCache,typeNameMappingES,signal)))).filter(t=>t!==null);if(signal.aborted)return null;let spriteUrl=data.sprites.other?.home?.front_default||data.sprites.other?.['official-artwork']?.front_default||data.sprites.front_default||`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${nationalId}.png`;let spriteShinyUrl=data.sprites.other?.home?.front_shiny||data.sprites.other?.['official-artwork']?.front_shiny||data.sprites.front_shiny||`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${nationalId}.png`;const pokemonNameES=pokemonNameMappingES[data.name]||await getTranslatedName('pokemon-species',data.name,new Map,pokemonNameMappingES,signal)||data.name.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());const generationName=speciesData?.generation?.name||"";const generation=romanToNumber[generationName.split("-")[1]]||null;let evolutionInfoString="No evoluciona m√°s.";if(speciesData&&speciesData.evolution_chain?.url&&!signal.aborted){try{const evolutionChainData=await fetchJson(speciesData.evolution_chain.url,signal);if(evolutionChainData?.chain&&!signal.aborted)evolutionInfoString=await getEvolutionInfo(evolutionChainData.chain,data.name,signal)}catch(error){console.warn(`Error al obtener cadena evolutiva para ${data.name}`);evolutionInfoString="Informaci√≥n de evoluci√≥n no disponible"}}let description="Descripci√≥n no disponible";if(speciesData?.flavor_text_entries){const spanishEntries=speciesData.flavor_text_entries.filter(entry=>entry.language.name==='es');let chosenEntry=spanishEntries.find(entry=>['sword','shield','scarlet','violet','legends-arceus'].includes(entry.version.name))||spanishEntries[spanishEntries.length-1];if(chosenEntry)description=chosenEntry.flavor_text.replace(/[\n\f\r]/g,' ').trim()}const stats={};data.stats?.forEach(stat=>{const name=stat.stat.name;if(name==='hp')stats.hp=stat.base_stat;else if(name==='attack')stats.attack=stat.base_stat;else if(name==='defense')stats.defense=stat.base_stat;else if(name==='special-attack')stats.specialAttack=stat.base_stat;else if(name==='special-defense')stats.specialDefense=stat.base_stat;else if(name==='speed')stats.speed=stat.base_stat});const abilities=[];if(data.abilities){for(const abilityInfo of data.abilities){if(signal.aborted)return null;try{const abilityData=await fetchJson(abilityInfo.ability.url,signal);const abilityNameEs=abilityData?.names?.find(name=>name.language.name==='es')?.name||abilityInfo.ability.name.replace(/-/g,' ');abilities.push({name:abilityNameEs,isHidden:abilityInfo.is_hidden})}catch(error){console.warn(`Error al obtener habilidad ${abilityInfo.ability.name}`);abilities.push({name:abilityInfo.ability.name.replace(/-/g,' '),isHidden:abilityInfo.is_hidden})}}}const pokemonInfo={nationalDexId:nationalId,name:pokemonNameES,sprite:spriteUrl,spriteShiny:spriteShinyUrl,types:typesInSpanish,originalTypes:typesInEnglish,evolutionInfo:evolutionInfoString,description:description,height:data.height/10,weight:data.weight/10,stats:stats,abilities:abilities,generation:generation,isLegendary:!!speciesData?.is_legendary,isMythical:!!speciesData?.is_mythical};pokemonDetailsCache.set(cacheKey,pokemonInfo);pokemonDetailsCache.set(String(nationalId),pokemonInfo);return pokemonInfo}
            async function getEvolutionInfo(chainStage,currentPokemonName,signal){const cacheKey=`${chainStage.species.name}-${currentPokemonName}`;if(evolutionCache.has(cacheKey))return evolutionCache.get(cacheKey);function findEvolutionDetails(stage,pokemonName){if(stage.species.name===pokemonName){return stage.evolves_to?.map(nextEv=>nextEv.evolution_details?.[0]?{evolvesTo:nextEv.species.name,details:nextEv.evolution_details[0]}:null).filter(Boolean)||[]}for(const nextStage of stage.evolves_to){const found=findEvolutionDetails(nextStage,pokemonName);if(found?.length>0)return found}return[]}const evolutionData=findEvolutionDetails(chainStage,currentPokemonName);if(!evolutionData||evolutionData.length===0){evolutionCache.set(cacheKey,"No evoluciona m√°s.");return"No evoluciona m√°s."}let allEvolutionsText=[];for(const evolution of evolutionData){const details=evolution.details;let parts=[];if(evolution.evolvesTo&&!signal.aborted){const nextEvoName=pokemonNameMappingES[evolution.evolvesTo]||await getTranslatedName('pokemon-species',evolution.evolvesTo,new Map,pokemonNameMappingES,signal)||evolution.evolvesTo.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());if(nextEvoName&&!signal.aborted)parts.push(`üîÑ Evoluciona a: <strong>${nextEvoName}</strong>`)}if(details.min_level!==null&&!signal.aborted)parts.push(`üìà Nivel m√≠nimo: ${details.min_level}`);if(details.item&&!signal.aborted){const itemName=itemNameMappingES[details.item.name]||await getTranslatedName('item',details.item.name,itemTranslationsCache,itemNameMappingES,signal);if(itemName)parts.push(`üéí Objeto necesario: ${itemName}`)}if(details.trigger&&!signal.aborted){const triggerName=triggerNameMappingES[details.trigger.name]||details.trigger.name.replace(/-/g,' ');parts.push(`‚ö° M√©todo: ${triggerName}`)}if(details.min_happiness!==null&&!signal.aborted)parts.push(`üíñ Felicidad m√≠nima: ${details.min_happiness}`);if(details.time_of_day&&details.time_of_day!==""&&!signal.aborted){const timeEmoji=details.time_of_day==='day'?'‚òÄÔ∏è':'üåô';const timeText=details.time_of_day==='day'?'D√≠a':'Noche';parts.push(`${timeEmoji} Momento: ${timeText}`)}if(details.location&&!signal.aborted){const locName=(await getTranslatedName('location',details.location.name,new Map,null,signal))||details.location.name.replace(/-/g,' ');parts.push(`üìç Lugar: ${locName.charAt(0).toUpperCase()+locName.slice(1)}`)}if(details.held_item&&!signal.aborted){const itemName=itemNameMappingES[details.held_item.name]||await getTranslatedName('item',details.held_item.name,itemTranslationsCache,itemNameMappingES,signal);if(itemName)parts.push(`üëú Objeto equipado: ${itemName}`)}if(details.known_move&&!signal.aborted){try{const moveData=await fetchJson(details.known_move.url,signal);if(moveData?.names){const moveNameEs=moveData.names.find(name=>name.language.name==='es')?.name||details.known_move.name.replace(/-/g,' ');parts.push(`üìù Movimiento necesario: ${moveNameEs}`)}}catch(e){console.warn(`Error al obtener movimiento ${details.known_move.name}`)}}if(details.known_move_type&&!signal.aborted){const moveTypeName=typeNameMappingES[details.known_move_type.name]||details.known_move_type.name;parts.push(`ü§∏ Movimiento de tipo ${moveTypeName} conocido`)}if(details.min_affection&&!signal.aborted)parts.push(`‚ù§Ô∏è Afecto m√≠nimo: ${details.min_affection}`);if(details.needs_overworld_rain&&!signal.aborted)parts.push(`üåßÔ∏è Necesita estar lloviendo en el mundo`);if(details.party_species&&!signal.aborted){const partySpeciesName=pokemonNameMappingES[details.party_species.name]||await getTranslatedName('pokemon-species',details.party_species.name,new Map,pokemonNameMappingES,signal)||details.party_species.name.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());parts.push(`üß© Necesita a ${partySpeciesName} en el equipo`)}if(details.party_type&&!signal.aborted){const partyTypeName=typeNameMappingES[details.party_type.name]||details.party_type.name;parts.push(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Pok√©mon de tipo ${partyTypeName} en el equipo`)}if(details.trade_species&&!signal.aborted){const tradeSpeciesName=pokemonNameMappingES[details.trade_species.name]||await getTranslatedName('pokemon-species',details.trade_species.name,new Map,pokemonNameMappingES,signal)||details.trade_species.name.replace(/-/g,' ').replace(/\b\w/g,l=>l.toUpperCase());parts.push(`ü§ù Intercambiar por ${tradeSpeciesName}`)}if(details.turn_upside_down&&!signal.aborted)parts.push(`üôÉ Girar la consola`);if(parts.length===0&&evolution.evolvesTo)parts.push(`(Condiciones especiales no detalladas)`);allEvolutionsText.push(`<div class="evolution-requirements">${parts.join('<br>')}</div>`)}const result=allEvolutionsText.join('');evolutionCache.set(cacheKey,result);return result}
            
            function createPokemonCard(pokemon){
                const card=document.createElement('div');
                card.className='pokemon-card';
                card.dataset.nationalId=pokemon.nationalDexId;
                if(pokemon.regionalDexNumber)card.dataset.regionalDexNumber=pokemon.regionalDexNumber;
                if(pokemon.isLegendary)card.classList.add('legendary-pokemon');
                if(pokemon.isMythical)card.classList.add('mythical-pokemon');
                
                let displayPokedexNumber=`#${String(pokemon.nationalDexId).padStart(4,'0')}`;
                if(pokemon.regionalDexNumber){
                    const map={"kanto":"Kanto","johto":"Johto","hoenn":"Hoenn","sinnoh":"Sinnoh","unova":"Unova","kalos":"Kalos","alola":"Alola","espada_galar":"Galar","hisui":"Hisui","purpura":"Paldea"};
                    const label=map[currentPokedexView];
                    if(label) displayPokedexNumber=`${label} #${String(pokemon.regionalDexNumber).padStart(3,'0')}`;
                }
                if(capturedPokemon.has(pokemon.nationalDexId))card.classList.add('captured');
                if(favoritePokemon.has(pokemon.nationalDexId))card.classList.add('favorite');
                
                const typeBadgesHTML=pokemon.types.map((typeEs,i)=>`<span class="type-badge type-${(pokemon.originalTypes[i]||'unknown').toLowerCase()}">${typeEs}</span>`).join('');
                
                card.innerHTML=`
                    <button class="card-info-btn" aria-label="Ver detalles de ${pokemon.name}">‚ùì</button>
                    <button class="card-compare-btn" aria-label="Comparar ${pokemon.name}">‚öîÔ∏è</button>
                    <button class="card-favorite-btn" aria-label="Marcar como favorito">${favoritePokemon.has(pokemon.nationalDexId)?'‚ù§':'‚ô°'}</button>
                    <div class="pokemon-card-image-container"><img src="${pokemon.sprite||'https://via.placeholder.com/140?text=?'}" alt="${pokemon.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/140?text=?';this.onerror=null;"></div>
                    <div class="pokemon-card-info"><h3>${pokemon.name}</h3><p class="pokedex-number">${displayPokedexNumber}</p><div class="pokemon-types">${typeBadgesHTML}</div></div>
                `;
                
                const infoBtn = card.querySelector('.card-info-btn');
                if (infoBtn) {
                    infoBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        showPokemonModal(pokemon);
                    });
                }
                const compareBtn = card.querySelector('.card-compare-btn');
                if (compareBtn) {
                    compareBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        pinPokemon(pokemon);
                    });
                }
                const favBtn = card.querySelector('.card-favorite-btn');
                if (favBtn) {
                    favBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleFavorite(pokemon, card);
                        favBtn.textContent = favoritePokemon.has(pokemon.nationalDexId) ? '‚ù§' : '‚ô°';
                    });
                }

                card.addEventListener('click', (event) => {
                    if (event.target.closest('.card-info-btn')) return;
                    if (event.target.closest('.card-favorite-btn')) return;
                    if (event.target.closest('.card-compare-btn')) return;
                    if (pokemonModalOverlay.classList.contains('visible')) return;
                    toggleCapture(pokemon, card);
                });
                return card;
            }

            function calculateOffensiveEffectiveness(pokemonStabTypes) {
                const effectiveness = { '4': [], '2': [], '1': [], '0.5': [], '0.25': [], '0': [] };
            
                allTypeKeys.forEach(defendingType => {
                    if (defendingType === 'unknown') return;
            
                    if (pokemonStabTypes.length === 0) { 
                        effectiveness['1'].push(defendingType);
                        return; 
                    }
            
                    let multipliers = pokemonStabTypes.map(attackingStabType => {
                        return typeChart[attackingStabType]?.[defendingType] ?? 1;
                    });
            
                    if (multipliers.includes(0)) {
                        effectiveness['0'].push(defendingType);
                    }
                    else if (pokemonStabTypes.length === 2 && multipliers.every(m => m === 2)) { // Ambos STABs x2
                        effectiveness['4'].push(defendingType);
                    }
                    else if (pokemonStabTypes.length === 2 && multipliers.every(m => m === 0.5)) { // Ambos STABs x0.5
                        effectiveness['0.25'].push(defendingType);
                    }
                    else if (multipliers.some(m => m === 2)) { // Al menos un STAB x2
                        effectiveness['2'].push(defendingType);
                    }
                    else if (multipliers.some(m => m === 0.5)) { // Al menos un STAB x0.5
                        effectiveness['0.5'].push(defendingType);
                    }
                    else { // Ninguna de las anteriores, entonces x1
                        effectiveness['1'].push(defendingType);
                    }
                });
                return effectiveness;
            }


            function displayOffensiveTypeEffectiveness(effectivenessData) {
                let html = '';
                const multipliersText = { 
                    '4': 'Muy Fuerte Contra (x4)',
                    '2': 'Fuerte Contra (x2)',
                    '1': 'Normal Contra (x1)',
                    '0.5': 'D√©bil Contra (x0.5)',
                    '0.25': 'Muy D√©bil Contra (x0.25)',
                    '0': 'Inmune Contra (x0)'
                };
                const displayOrder = ['4', '2', '1', '0.5', '0.25', '0']; 
                
                let foundAny = false;
                for (const multiplier of displayOrder) {
                    if (effectivenessData[multiplier] && effectivenessData[multiplier].length > 0) {
                        foundAny = true;
                        html += `<div class="type-effectiveness-group"><h5>${multipliersText[multiplier]}:</h5>`;
                        effectivenessData[multiplier].forEach(type => {
                            const typeName = typeNameMappingES[type.toLowerCase()] || type.charAt(0).toUpperCase() + type.slice(1);
                            html += `<span class="type-badge type-${type.toLowerCase()}">${typeName}</span> `;
                        });
                        html += `</div>`;
                    }
                }
                return foundAny ? html : '<p>No hay interacciones de tipo ofensivas notables para mostrar.</p>';
            }


            function showPokemonModal(pokemon) {
                currentPokemonInModal = pokemon; 
                modalPokemonName.textContent = pokemon.name;
                modalPokemonSprite.src = pokemon.sprite;
                modalPokemonSprite.alt = pokemon.name;

                modalPokemonTypes.innerHTML = pokemon.types.map((typeEs, i) => 
                    `<span class="type-badge type-${(pokemon.originalTypes[i]||'unknown').toLowerCase()}">${typeEs}</span>`
                ).join('');
                
                modalPokemonDescription.textContent = pokemon.description;

                let statsHtml = `
                    <div class="modal-stat"><span class="modal-stat-name">Altura:</span> <span class="modal-stat-value">${pokemon.height} m</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">Peso:</span> <span class="modal-stat-value">${pokemon.weight} kg</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">HP:</span> <span class="modal-stat-value">${pokemon.stats.hp || '?'}</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">Ataque:</span> <span class="modal-stat-value">${pokemon.stats.attack || '?'}</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">Defensa:</span> <span class="modal-stat-value">${pokemon.stats.defense || '?'}</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">At. Esp:</span> <span class="modal-stat-value">${pokemon.stats.specialAttack || '?'}</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">Def. Esp:</span> <span class="modal-stat-value">${pokemon.stats.specialDefense || '?'}</span></div>
                    <div class="modal-stat"><span class="modal-stat-name">Velocidad:</span> <span class="modal-stat-value">${pokemon.stats.speed || '?'}</span></div>
                `;
                modalPokemonStats.innerHTML = statsHtml;
                
                modalPokemonAbilities.innerHTML = pokemon.abilities.map(ab => 
                    `<li><strong>${ab.name}</strong>${ab.isHidden ? ' (Oculta)' : ''}</li>`
                ).join('');

                if (pokemon.evolutionInfo && pokemon.evolutionInfo !== "No evoluciona m√°s.") {
                    modalPokemonEvolution.innerHTML = pokemon.evolutionInfo;
                    modalEvolutionSection.style.display = 'block';
                } else {
                     modalPokemonEvolution.innerHTML = "<p>Este Pok√©mon es la forma final o no evoluciona.</p>";
                    modalEvolutionSection.style.display = 'block';
                }
                
                const offensiveEffectiveness = calculateOffensiveEffectiveness(pokemon.originalTypes);
                modalPokemonTypeEffectiveness.innerHTML = displayOffensiveTypeEffectiveness(offensiveEffectiveness);
                if (modalTypeEffectivenessTitle) { 
                     modalTypeEffectivenessTitle.innerHTML = `‚öîÔ∏è Efectividad Ofensiva <span style="font-weight:normal;font-size:0.9em;">(Da√±o causado por ${pokemon.name})</span>`;
                }

                updateModalCaptureButton(pokemon.nationalDexId);

                pokemonModalOverlay.classList.add('visible');
                document.body.classList.add('modal-open');
            }

            function hidePokemonModal() {
                pokemonModalOverlay.classList.remove('visible');
                document.body.classList.remove('modal-open');
                currentPokemonInModal = null;
            }

            function buildComparisonHTML(p1, p2) {
                const buildTypes = (p) => p.types.map((t,i)=>`<span class="type-badge type-${(p.originalTypes[i]||'unknown').toLowerCase()}">${t}</span>`).join(' ');
                const buildAbilities = (p) => p.abilities.map(ab=>`<li><strong>${ab.name}</strong>${ab.isHidden?' (Oculta)':''}</li>`).join('');
                const buildStats = (p) => `
                    <table class="stats-table">
                        <tr><th>HP</th><td>${p.stats.hp||'?'}</td></tr>
                        <tr><th>Ataque</th><td>${p.stats.attack||'?'}</td></tr>
                        <tr><th>Defensa</th><td>${p.stats.defense||'?'}</td></tr>
                        <tr><th>At. Esp</th><td>${p.stats.specialAttack||'?'}</td></tr>
                        <tr><th>Def. Esp</th><td>${p.stats.specialDefense||'?'}</td></tr>
                        <tr><th>Velocidad</th><td>${p.stats.speed||'?'}</td></tr>
                    </table>`;
                const totalStats = p => (p.stats.hp||0)+(p.stats.attack||0)+(p.stats.defense||0)+(p.stats.specialAttack||0)+(p.stats.specialDefense||0)+(p.stats.speed||0);
                const dmgMultiplier = (att, def) => {
                    if(!att.originalTypes||att.originalTypes.length===0) return 1;
                    return Math.max(...att.originalTypes.map(at=>{
                        return def.originalTypes.reduce((m,dt)=>m*(typeChart[at]?.[dt]??1),1);
                    }));
                };
                const score1 = totalStats(p1) * dmgMultiplier(p1,p2);
                const score2 = totalStats(p2) * dmgMultiplier(p2,p1);
                const winner = score1===score2? 'draw' : (score1>score2? 'p1' : 'p2');
                const col1Class = winner==='p1' ? 'winner' : (winner==='p2' ? 'loser' : '');
                const col2Class = winner==='p2' ? 'winner' : (winner==='p1' ? 'loser' : '');
                const label1 = winner==='p1' ? 'Vencedor' : (winner==='p2' ? 'Perdedor' : 'Empate');
                const label2 = winner==='p2' ? 'Vencedor' : (winner==='p1' ? 'Perdedor' : 'Empate');
                return `
                    <div class="comp-column ${col1Class}">
                        <div class="winner-label">${label1}</div>
                        <h3>${p1.name}</h3>
                        <img src="${p1.sprite}" alt="${p1.name}">
                        <div>${buildTypes(p1)}</div>
                        <h4>Habilidades</h4>
                        <ul>${buildAbilities(p1)}</ul>
                        <h4>Estad√≠sticas</h4>
                        ${buildStats(p1)}
                    </div>
                    <div class="comp-column ${col2Class}">
                        <div class="winner-label">${label2}</div>
                        <h3>${p2.name}</h3>
                        <img src="${p2.sprite}" alt="${p2.name}">
                        <div>${buildTypes(p2)}</div>
                        <h4>Habilidades</h4>
                        <ul>${buildAbilities(p2)}</ul>
                        <h4>Estad√≠sticas</h4>
                        ${buildStats(p2)}
                    </div>`;
            }

            function showComparison() {
                if (!pinnedPokemon1 || !pinnedPokemon2) return;
                comparisonContent.innerHTML = buildComparisonHTML(pinnedPokemon1, pinnedPokemon2);
                comparisonOverlay.classList.add('visible');
                document.body.classList.add('modal-open');
            }

            function hideComparison(clearPins = false) {
                comparisonOverlay.classList.remove('visible');
                document.body.classList.remove('modal-open');
                if (clearPins) {
                    pinnedPokemon1 = null;
                    pinnedPokemon2 = null;
                    comparisonContent.innerHTML = '';
                }
            }
            window.hideComparison = hideComparison;

            function pinPokemon(pokemon) {
                if (!pinnedPokemon1) {
                    pinnedPokemon1 = pokemon;
                    showNotification('Pok√©mon fijado', `${pokemon.name} listo para comparar.`, 'üìå');
                } else if (!pinnedPokemon2 && pinnedPokemon1.nationalDexId !== pokemon.nationalDexId) {
                    pinnedPokemon2 = pokemon;
                    showNotification('Segundo Pok√©mon fijado', `${pokemon.name} a√±adido a la comparaci√≥n.`, 'üìå');
                    hidePokemonModal();
                    showComparison();
                } else {
                    showNotification('Comparaci√≥n', 'Ya has fijado este Pok√©mon.', '‚ÑπÔ∏è');
                }
            }

            function updateModalCaptureButton(nationalId) {
                const isCaptured = capturedPokemon.has(nationalId);
                modalToggleCaptureBtn.textContent = isCaptured ? 'Liberar Pok√©mon' : 'Capturar Pok√©mon';
                if (isCaptured) {
                    modalToggleCaptureBtn.style.background = 'linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%)'; 
                    modalToggleCaptureBtn.style.color = 'var(--primary-red)';
                    modalToggleCaptureBtn.style.borderColor = 'var(--missing-red-border)';
                } else {
                    modalToggleCaptureBtn.style.background = ''; 
                    modalToggleCaptureBtn.style.color = '';
                    modalToggleCaptureBtn.style.borderColor = '';
                }
            }
            
            modalToggleCaptureBtn.addEventListener('click', () => {
                if (!currentPokemonInModal) return;
                const pokemon = currentPokemonInModal;
                const cardElement = document.querySelector(`.pokemon-card[data-national-id="${pokemon.nationalDexId}"]`);
                toggleCapture(pokemon, cardElement);
                updateModalCaptureButton(pokemon.nationalDexId);
            });


            if (comparisonCloseBtn) comparisonCloseBtn.addEventListener('click', () => hideComparison(true));
            if (comparisonOverlay) comparisonOverlay.addEventListener('click', e => { if (e.target === comparisonOverlay) hideComparison(true); });

            modalCloseBtn.addEventListener('click', hidePokemonModal);
            pokemonModalOverlay.addEventListener('click', (event) => {
                if (event.target === pokemonModalOverlay) { 
                    hidePokemonModal();
                }
            });

            function toggleCapture(pokemon, cardElement) {
                const nationalId = pokemon.nationalDexId;
                const wasCaptured = capturedPokemon.has(nationalId);

                if (wasCaptured) {
                    capturedPokemon.delete(nationalId);
                    if (cardElement) cardElement.classList.remove('captured');
                    showNotification('Pok√©mon liberado', `Has eliminado a ${pokemon.name} de tu colecci√≥n.`, 'üîÑ');
                } else {
                    capturedPokemon.add(nationalId);
                    if (cardElement) cardElement.classList.add('captured');
                    showNotification('¬°Pok√©mon capturado!', `Has a√±adido a ${pokemon.name} a tu colecci√≥n.`, 'üéâ');
                }
                saveCapturedPokemon();
                
                if (cardElement && (activeFilters.has('captured') || activeFilters.has('missing'))) {
                    applyFiltersAndRender(true);
                } else {
                    const currentFilteredList = getCurrentFilteredList();
                    updateCaptureCounter(true, currentFilteredList);
                }

                if (currentPokemonInModal && currentPokemonInModal.nationalDexId === nationalId) {
                    updateModalCaptureButton(nationalId);
                }
            }

            function toggleFavorite(pokemon, cardElement) {
                const id = pokemon.nationalDexId;
                const wasFavorite = favoritePokemon.has(id);
                if (wasFavorite) {
                    favoritePokemon.delete(id);
                    if (cardElement) cardElement.classList.remove('favorite');
                    showNotification('Favorito eliminado', `${pokemon.name} ya no es favorito.`, 'üíî');
                } else {
                    favoritePokemon.add(id);
                    if (cardElement) cardElement.classList.add('favorite');
                    showNotification('Pok√©mon favorito', `${pokemon.name} marcado como favorito.`, '‚ù§Ô∏è');
                }
                saveFavoritePokemon();
                if (cardElement && activeFilters.has('favorite')) {
                    applyFiltersAndRender(true);
                }
            }

            function getCurrentFilteredList() {
                if (!currentPokedexFullData) return [];
                let list = [...currentPokedexFullData];
                const searchTerm = searchInput.value.trim().toLowerCase();

                if (searchTerm) {
                    const searchNum = parseInt(searchTerm);
                    if (!isNaN(searchNum)) {
                        list = list.filter(p => (currentPokedexView === 'national' ? p.nationalDexId : p.regionalDexNumber) === searchNum);
                    } else {
                        const parts = searchTerm.split(/[ ,]+/).filter(Boolean);
                        const mapped = parts.map(part => {
                            if(allTypeKeys.includes(part)) return part;
                            const matchKey = Object.keys(typeNameMappingES).find(k => typeNameMappingES[k].toLowerCase() === part);
                            return matchKey || null;
                        });
                        if (mapped.length === parts.length && mapped.length > 0 && mapped.every(Boolean)) {
                            list = list.filter(p => mapped.every(t => p.originalTypes.includes(t)));
                        } else {
                            list = list.filter(p => p.name.toLowerCase().includes(searchTerm) || p.abilities.some(ab => ab.name.toLowerCase().includes(searchTerm)));
                        }
                    }
                }
                if (!activeFilters.has('all') || activeFilters.size > 1) {
                    activeFilters.forEach(filter => {
                        if (filter === 'all') return; 
                        switch (filter) {
                            case 'captured': list = list.filter(p => capturedPokemon.has(p.nationalDexId)); break;
                            case 'missing': list = list.filter(p => !capturedPokemon.has(p.nationalDexId)); break;
                              case 'legendary': list = list.filter(p => p.isLegendary); break;
                              case 'mythical': list = list.filter(p => p.isMythical); break;
                              case 'favorite': list = list.filter(p => favoritePokemon.has(p.nationalDexId)); break;
                              case 'gen1': list = list.filter(p => p.generation === 1); break;
                            case 'gen2': list = list.filter(p => p.generation === 2); break;
                            case 'gen3': list = list.filter(p => p.generation === 3); break;
                            case 'gen4': list = list.filter(p => p.generation === 4); break;
                            case 'gen5': list = list.filter(p => p.generation === 5); break;
                            case 'gen6': list = list.filter(p => p.generation === 6); break;
                            case 'gen7': list = list.filter(p => p.generation === 7); break;
                            case 'gen8': list = list.filter(p => p.generation === 8); break;
                            case 'gen9': list = list.filter(p => p.generation === 9); break;
                            case 'attack100': list = list.filter(p => (p.stats.attack||0) >= 100); break;
                            case 'defense100': list = list.filter(p => (p.stats.defense||0) >= 100); break;
                            case 'speed100': list = list.filter(p => (p.stats.speed||0) >= 100); break;
                            default: if (allTypeKeys.includes(filter)) {
                                list = list.filter(p => p.originalTypes.includes(filter));
                            }
                            break;
                        }
                    });
                }
                return list;
            }

            function renderPokedex(listToRender){if(!pokedexContainer)return;pokedexContainer.innerHTML='';if(!listToRender||listToRender.length===0){showStatusMessage(searchInput?.value.trim()?'üîç No se encontraron Pok√©mon que coincidan con tu b√∫squeda':'üì≠ No hay Pok√©mon para mostrar con este filtro');return}pokedexContainer.classList.toggle('search-results',!!searchInput?.value.trim());listToRender.forEach((pokemon,index)=>{if(pokemon){const card=createPokemonCard(pokemon);pokedexContainer.appendChild(card)}});hideStatusMessage()}
            async function nationalDexFetcher(signal){showStatusMessage('‚ö° Cargando Pok√©dex Nacional...');const listData=await fetchJson(`${API_BASE_URL}pokemon?limit=${MAX_NATIONAL_DEX_FETCH_LIMIT}&offset=0`,signal);if(!listData||signal.aborted)return null;const batchSize=50;const results=[];for(let i=0;i<listData.results.length;i+=batchSize){if(signal.aborted)return null;const batchPromises=listData.results.slice(i,i+batchSize).map(p=>getPokemonDetails(p.name,signal));results.push(...(await Promise.all(batchPromises)).filter(p=>p!=null));showStatusMessage(`‚ö° Cargando Pok√©dex Nacional... ${Math.min(Math.round(((i+batchSize)/listData.results.length)*100),100)}%`)}return results.sort((a,b)=>a.nationalDexId-b.nationalDexId)}
            async function regionalDexFetcher(regionKey,signal){const regionNames={'kanto':'Kanto','johto':'Johto','hoenn':'Hoenn','sinnoh':'Sinnoh','unova':'Unova','kalos':'Kalos','alola':'Alola','espada_galar':'Espada (Galar)','hisui':'Arceus (Hisui)','purpura':'P√∫rpura (Paldea)'};showStatusMessage(`‚ö° Cargando Pok√©dex de ${regionNames[regionKey]}...`);const pokedexData=await fetchJson(`${API_BASE_URL}pokedex/${REGIONAL_DEX_IDS[regionKey]}/`,signal);if(!pokedexData||signal.aborted)return null;const batchSize=30;const results=[];for(let i=0;i<pokedexData.pokemon_entries.length;i+=batchSize){if(signal.aborted)return null;const batchPromises=pokedexData.pokemon_entries.slice(i,i+batchSize).map(async(entry)=>{if(signal.aborted)return null;const nationalId=parseInt(entry.pokemon_species.url.split('/')[entry.pokemon_species.url.split('/').length-2]);if(isNaN(nationalId))return null;const details=await getPokemonDetails(nationalId,signal);return details?{...details,regionalDexNumber:entry.entry_number}:null});results.push(...(await Promise.all(batchPromises)).filter(p=>p!=null));showStatusMessage(`‚ö° Cargando Pok√©dex de ${regionNames[regionKey]}... ${Math.min(Math.round(((i+batchSize)/pokedexData.pokemon_entries.length)*100),100)}%`)}return results.sort((a,b)=>Number(a.regionalDexNumber)-Number(b.regionalDexNumber))}
            function loadCapturedPokemon(){const s=localStorage.getItem('pokemonUltimateCapturesV3');if(s)capturedPokemon=new Set(JSON.parse(s).map(Number))}
            function saveCapturedPokemon(){localStorage.setItem('pokemonUltimateCapturesV3',JSON.stringify(Array.from(capturedPokemon)))}
            function loadFavoritePokemon(){const s=localStorage.getItem('pokemonUltimateFavoritesV1');if(s)favoritePokemon=new Set(JSON.parse(s).map(Number))}
            function saveFavoritePokemon(){localStorage.setItem('pokemonUltimateFavoritesV1',JSON.stringify(Array.from(favoritePokemon)))}
            function updateCaptureCounter(animate=false,listToCount){if(!captureCounterNavElement)return;if(!listToCount){captureCounterNavElement.textContent=`0 / 0`;return}const total=listToCount.length;const capturedCount=listToCount.filter(p=>capturedPokemon.has(p.nationalDexId)).length;captureCounterNavElement.textContent=`${capturedCount} / ${total}`;if(animate){captureCounterNavElement.style.transform='scale(1.2)';setTimeout(()=>{captureCounterNavElement.style.transform='scale(1)'},200)}}
            function setActiveButtonUI(activeBtn){allNavButtons.forEach(btn=>btn.classList.remove('active'));if(activeBtn)activeBtn.classList.add('active');if(searchInput&&activeBtn&&!activeBtn.classList.contains('filter-option') && !activeBtn.id.startsWith('btnDataMenu') )searchInput.value=''}
            function updateActiveFiltersUI() {
                filterOptions.forEach(opt => {
                    if (activeFilters.has(opt.dataset.filter)) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });
            }
            function applyFiltersAndRender(animateCounter = false) {
                const filteredList = getCurrentFilteredList();
                renderPokedex(filteredList);
                updateCaptureCounter(animateCounter, filteredList); 
            }
            async function fetchPokedexData(pokedexKey,fetcherFunction,buttonElement){if(buttonElement.classList.contains('active')&&!buttonElement.id.startsWith('btnDataMenu') &&!searchInput?.value.trim()){window.scrollTo({top:0,behavior:'smooth'});if(pokedexListCache.has(pokedexKey)&&currentPokedexView===pokedexKey)return}fetchAbortController?.abort();fetchAbortController=new AbortController;const signal=fetchAbortController.signal;setActiveButtonUI(buttonElement);currentPokedexView=pokedexKey;if(pokedexListCache.has(pokedexKey)){currentPokedexFullData=pokedexListCache.get(pokedexKey);applyFiltersAndRender();hideStatusMessage();if(currentPokedexFullData.length>0&&!searchInput?.value.trim())window.scrollTo({top:0,behavior:'smooth'});return}setLoadingState(buttonElement,true);if(pokedexContainer)pokedexContainer.innerHTML='';try{const data=await fetcherFunction(signal);if(data&&!signal.aborted){currentPokedexFullData=data;pokedexListCache.set(pokedexKey,data);applyFiltersAndRender();hideStatusMessage();if(data.length>0&&!searchInput?.value.trim())window.scrollTo({top:0,behavior:'smooth'})}else if(!signal.aborted){currentPokedexFullData=[];applyFiltersAndRender();showStatusMessage('‚ùå No se pudieron cargar los datos. Intenta de nuevo.',true)}}catch(error){if(error.name!=='AbortError'){console.error("Error en fetchPokedexData:",error);currentPokedexFullData=[];applyFiltersAndRender();showStatusMessage('‚ùå Error al cargar. Verifica conexi√≥n.',true)}}finally{if(!signal.aborted)setLoadingState(buttonElement,false)}}
            function handleScrollToTopButtonVisibility(){if(scrollToTopBtn){const threshold=parseFloat(getComputedStyle(document.documentElement).fontSize)*31.25;scrollToTopBtn.classList.toggle('visible',window.scrollY>threshold)}}
            function exportCapturedData(){const dataToExport={version:"pokedex-ultimate-captures-v1.0",captured:Array.from(capturedPokemon)};const jsonString=JSON.stringify(dataToExport,null,2);const blob=new Blob([jsonString],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="pokedex_captures.json";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showNotification("üíæ Datos Exportados","Tu lista de Pok√©mon capturados ha sido guardada.","‚úÖ")}
            function importCapturedData(event){const file=event.target.files[0];if(!file){showNotification("‚ö†Ô∏è Importaci√≥n Cancelada","No se seleccion√≥ ning√∫n archivo.","üìÑ",4E3);return}if(file.type!=="application/json"){showNotification("‚ùå Error de Archivo","Por favor, selecciona un archivo .json v√°lido.","üìÑ",4E3);event.target.value=null;return}const reader=new FileReader;reader.onload=e=>{try{const importedData=JSON.parse(e.target.result);if(importedData&&importedData.version&&Array.isArray(importedData.captured)){const newCapturedSet=new Set(importedData.captured.map(Number).filter(id=>!isNaN(id)));capturedPokemon=newCapturedSet;saveCapturedPokemon();applyFiltersAndRender(true);showNotification("üìÇ Datos Importados","Tu lista de Pok√©mon capturados ha sido actualizada.","‚úÖ")}else{throw new Error("El archivo JSON no tiene el formato esperado.")}}catch(error){console.error("Error al importar datos:",error);showNotification("‚ùå Error de Importaci√≥n","El archivo no pudo ser procesado. Verifica el formato.","üìÑ",5E3)}finally{event.target.value=null}};reader.onerror=()=>{showNotification("‚ùå Error de Lectura","No se pudo leer el archivo seleccionado.","üìÑ",5E3);event.target.value=null};reader.readAsText(file)}
            if (btnDataMenu && dataDropdownContent && dataMenuContainer) {
                btnDataMenu.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    const isCurrentlyVisibleByCssHover = getComputedStyle(dataDropdownContent).display === 'block' && dataMenuContainer.matches(':hover');
                    if (!isCurrentlyVisibleByCssHover) {
                        dataDropdownContent.classList.toggle('show');
                    }
                    btnDataMenu.classList.toggle('open', dataDropdownContent.classList.contains('show') || isCurrentlyVisibleByCssHover);
                });
                document.addEventListener('click', (event) => {
                    const isHoverActiveOnContainer = dataMenuContainer.matches(':hover');
                    if (!isHoverActiveOnContainer && !dataMenuContainer.contains(event.target) && dataDropdownContent.classList.contains('show')) {
                        dataDropdownContent.classList.remove('show');
                        btnDataMenu.classList.remove('open');
                    }
                });
                dataMenuContainer.addEventListener('mouseleave', () => {
                    setTimeout(() => { 
                        if (!dataMenuContainer.matches(':hover') && !dataDropdownContent.matches(':hover')) {
                            if (!dataDropdownContent.classList.contains('show')) { 
                                btnDataMenu.classList.remove('open');
                            }
                        }
                    }, 100); 
                });
                 dataMenuContainer.addEventListener('mouseenter', () => {
                     if(getComputedStyle(dataDropdownContent).display === 'block' || dataDropdownContent.classList.contains('show')) {
                        btnDataMenu.classList.add('open');
                     }
                });
            }
            document.addEventListener('keydown',event=>{
                if(event.key==="Escape"){
                    if (pokemonModalOverlay.classList.contains('visible')) {
                        hidePokemonModal();
                    } else {
                        if(searchInput&&document.activeElement===searchInput) searchInput.blur();
                        if(searchInput?.value!=="") { searchInput.value=""; applyFiltersAndRender(); }
                        if(dataDropdownContent && (dataDropdownContent.classList.contains('show') || getComputedStyle(dataDropdownContent).display === 'block' )) { 
                            dataDropdownContent.classList.remove('show'); btnDataMenu.classList.remove('open');
                        }
                        if (!pokemonModalOverlay.classList.contains('visible') && document.activeElement !== searchInput) {
                             window.scrollTo({top:0,behavior:'smooth'});
                        }
                    }
                } else if(event.key==="Backspace"){
                    if(searchInput&&document.activeElement!==searchInput && !pokemonModalOverlay.classList.contains('visible')){ 
                        searchInput.value="";searchInput.focus();applyFiltersAndRender();event.preventDefault()
                    }
                }
            });
            if(searchInput){searchInput.addEventListener('input',()=>applyFiltersAndRender());searchInput.addEventListener('focus',()=>searchInput.style.transform='scale(1.02)');searchInput.addEventListener('blur',()=>searchInput.style.transform='scale(1)')}
            filterOptions.forEach(option => {
                option.addEventListener('click', e => {
                    const clickedFilter = e.target.closest('.filter-option').dataset.filter; 
                    if (clickedFilter === 'all') {
                        activeFilters.clear();
                        activeFilters.add('all');
                    } else {
                        activeFilters.delete('all'); 
                        if (activeFilters.has(clickedFilter)) {
                            activeFilters.delete(clickedFilter); 
                        } else {
                            activeFilters.add(clickedFilter); 
                        }
                        if (activeFilters.size === 0) {
                            activeFilters.add('all');
                        }
                    }
                    updateActiveFiltersUI();
                    applyFiltersAndRender();
                });
            });
            if(btnHome)btnHome.addEventListener('click',()=>fetchPokedexData('national',nationalDexFetcher,btnHome));
            if(btnEspadaGalar)btnEspadaGalar.addEventListener('click',()=>fetchPokedexData('espada_galar',()=>regionalDexFetcher('espada_galar',fetchAbortController.signal),btnEspadaGalar));
            if(btnHisui)btnHisui.addEventListener('click',()=>fetchPokedexData('hisui',()=>regionalDexFetcher('hisui',fetchAbortController.signal),btnHisui));
            if(btnPurpura)btnPurpura.addEventListener('click',()=>fetchPokedexData('purpura',()=>regionalDexFetcher('purpura',fetchAbortController.signal),btnPurpura));
            if(scrollToTopBtn)scrollToTopBtn.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
            if(btnExportData)btnExportData.addEventListener('click',exportCapturedData);
            if(btnKanto)btnKanto.addEventListener("click",()=>fetchPokedexData("kanto",()=>regionalDexFetcher("kanto",fetchAbortController.signal),btnKanto));
            if(btnJohto)btnJohto.addEventListener("click",()=>fetchPokedexData("johto",()=>regionalDexFetcher("johto",fetchAbortController.signal),btnJohto));
            if(btnHoenn)btnHoenn.addEventListener("click",()=>fetchPokedexData("hoenn",()=>regionalDexFetcher("hoenn",fetchAbortController.signal),btnHoenn));
            if(btnSinnoh)btnSinnoh.addEventListener("click",()=>fetchPokedexData("sinnoh",()=>regionalDexFetcher("sinnoh",fetchAbortController.signal),btnSinnoh));
            if(btnUnova)btnUnova.addEventListener("click",()=>fetchPokedexData("unova",()=>regionalDexFetcher("unova",fetchAbortController.signal),btnUnova));
            if(btnKalos)btnKalos.addEventListener("click",()=>fetchPokedexData("kalos",()=>regionalDexFetcher("kalos",fetchAbortController.signal),btnKalos));
            if(btnAlola)btnAlola.addEventListener("click",()=>fetchPokedexData("alola",()=>regionalDexFetcher("alola",fetchAbortController.signal),btnAlola));
            if(btnImportDataTrigger)btnImportDataTrigger.addEventListener('click',()=>fileImporter.click());
            if(fileImporter)fileImporter.addEventListener('change',importCapturedData);
            window.addEventListener('scroll',handleScrollToTopButtonVisibility);
            adjustMainPadding();window.addEventListener('resize',adjustMainPadding);
            loadCapturedPokemon();
            loadFavoritePokemon();
            updateActiveFiltersUI(); 
            if(btnHome)fetchPokedexData('national',nationalDexFetcher,btnHome);else applyFiltersAndRender();
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'pokedex-cache-v1';
                const API_PREFIX = 'https://pokeapi.co/api/v2/';
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => cache.addAll(['./','./POKEDEX%20OFICIAL.html'])).then(() => self.skipWaiting())
                    );
                });
                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(keys => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))).then(() => self.clients.claim())
                    );
                });
                async function cacheFirst(request) {
                    const cached = await caches.match(request);
                    if (cached) return cached;
                    const response = await fetch(request);
                    const cache = await caches.open(CACHE_NAME);
                    cache.put(request, response.clone());
                    return response;
                }
                async function networkFirst(request) {
                    try {
                        const response = await fetch(request);
                        const cache = await caches.open(CACHE_NAME);
                        cache.put(request, response.clone());
                        return response;
                    } catch (err) {
                        return caches.match(request);
                    }
                }
                self.addEventListener('fetch', event => {
                    if (event.request.method !== 'GET') return;
                    const url = new URL(event.request.url);
                    if (url.href.startsWith(API_PREFIX)) {
                        event.respondWith(networkFirst(event.request));
                    } else if (url.origin === location.origin) {
                        event.respondWith(cacheFirst(event.request));
                    }
                });
            `;
            const swUrl = URL.createObjectURL(new Blob([swCode], { type: 'text/javascript' }));
            navigator.serviceWorker.register(swUrl);
        }
    </script>
</body>
</html>